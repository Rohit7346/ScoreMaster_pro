<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScoreMaster Pro | Tournament Scoring</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800;900&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-dark: #0a0e17;
            --secondary-dark: #141a2a;
            --card-dark: #1a2238;
            --accent-green: #00ff8b;
            --accent-green-dark: #00cc6f;
            --text-primary: #ffffff;
            --text-secondary: #b0b7cb;
            --text-muted: #6c748a;
            --border-color: #2a3655;
            --success: #00c853;
            --warning: #ff9800;
            --danger: #f44336;
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --border-radius: 10px;
            --mobile-breakpoint: 768px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--primary-dark);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        h1, h2, h3, h4 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header Styles - Responsive */
        header {
            background-color: var(--secondary-dark);
            border-bottom: 2px solid var(--accent-green);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--accent-green);
        }
        
        .logo i {
            margin-right: 10px;
            font-size: 2rem;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-green), #00ccff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        /* Main Content Area */
        main {
            padding: 30px 0;
            min-height: calc(100vh - 140px);
        }
        
        .dashboard-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .dashboard-section.active {
            display: block;
        }
        
        /* Navigation - Responsive */
        .main-nav {
            display: flex;
            background-color: var(--secondary-dark);
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        @media (max-width: 768px) {
            .main-nav {
                flex-wrap: wrap;
            }
            
            .nav-item {
                flex: 1 0 50%;
                min-width: 140px;
                padding: 15px 5px;
                font-size: 1rem;
            }
        }
        
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 18px 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
        }
        
        .nav-item:hover {
            background-color: rgba(0, 255, 139, 0.1);
        }
        
        .nav-item.active {
            background-color: rgba(0, 255, 139, 0.15);
            border-bottom: 3px solid var(--accent-green);
            color: var(--accent-green);
        }
        
        /* Sport Selection Dashboard - Responsive */
        .sport-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        /* HIDDEN: Remove descriptions from sport cards */
        .sport-card .sport-desc {
            display: none;
        }
        
        @media (max-width: 768px) {
            .sport-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 15px;
            }
        }
        
        .sport-card {
            background-color: var(--card-dark);
            border-radius: var(--border-radius);
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        .sport-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow);
            border-color: var(--accent-green);
        }
        
        .sport-card.selected {
            border-color: var(--accent-green);
            background-color: rgba(0, 255, 139, 0.05);
        }
        
        .sport-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--accent-green);
        }
        
        .sport-name {
            font-size: 1.5rem;
            margin-bottom: 0; 
        }
        
        /* Tournament Setup Section */
        .setup-container {
            background-color: var(--card-dark);
            border-radius: var(--border-radius);
            padding: 30px;
            border: 1px solid var(--border-color);
        }
        
        @media (max-width: 768px) {
            .setup-container {
                padding: 20px;
            }
        }
        
        .setup-step {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .setup-step.active {
            display: block;
        }
        
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        @media (max-width: 768px) {
            .step-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            background-color: var(--accent-green);
            color: var(--primary-dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.2rem;
            margin-right: 15px;
        }
        
        .step-title {
            font-size: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--secondary-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: var(--transition);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 2px rgba(0, 255, 139, 0.2);
        }
        
        .form-control-sm {
            max-width: 150px;
        }
        
        @media (max-width: 768px) {
            .form-control-sm {
                max-width: 100%;
            }
        }
        
        /* Sport-specific controls */
        .sport-specific-controls {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background-color: rgba(0, 255, 139, 0.05);
            border-radius: var(--border-radius);
            border: 1px solid var(--accent-green);
        }
        
        .sport-specific-controls.active {
            display: block;
        }
        
        /* Cricket specific */
        .cricket-controls .control-btn {
            background-color: rgba(0, 200, 83, 0.1);
        }
        
        /* Football specific */
        .football-controls .control-btn {
            background-color: rgba(33, 150, 243, 0.1);
        }

        /* Custom specific */
        .custom-controls .control-btn {
            background-color: rgba(255, 152, 0, 0.1);
        }
        
        .btn {
            padding: 12px 30px;
            background-color: var(--accent-green);
            color: var(--primary-dark);
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            background-color: var(--accent-green-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 139, 0.3);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--accent-green);
            color: var(--accent-green);
        }
        
        .btn-outline:hover {
            background-color: rgba(0, 255, 139, 0.1);
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        /* Navigation buttons */
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        @media (max-width: 768px) {
            .navigation-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .navigation-buttons .btn {
                width: 100%;
            }
        }
        
        /* Teams Setup - Responsive */
        .teams-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .teams-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        
        .team-card {
            background-color: var(--card-dark);
            border-radius: var(--border-radius);
            padding: 20px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }
        
        .team-card:hover {
            border-color: var(--accent-green);
        }
        
        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .team-name-input {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1.3rem;
            font-weight: 700;
            width: 100%;
            padding: 5px;
        }
        
        .team-name-input:focus {
            outline: none;
            border-bottom: 2px solid var(--accent-green);
        }
        
        .player-list {
            list-style: none;
        }
        
        .player-item {
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player-item:last-child {
            border-bottom: none;
        }
        
        .player-name-input {
            background: transparent;
            border: none;
            color: var(--text-primary);
            width: 70%;
            padding: 5px;
        }
        
        .player-name-input:focus {
            outline: none;
            border-bottom: 1px solid var(--accent-green);
        }
        
        /* Match Setup - Responsive */
        .match-setup-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        
        @media (max-width: 992px) {
            .match-setup-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        
        .match-options {
            background-color: var(--card-dark);
            border-radius: var(--border-radius);
            padding: 30px;
            border: 1px solid var(--border-color);
        }
        
        @media (max-width: 768px) {
            .match-options {
                padding: 15px;
            }
        }
        
        .teams-selection {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }
        
        .team-select {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background-color: var(--secondary-dark);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .team-select:hover {
            background-color: rgba(0, 255, 139, 0.05);
        }
        
        .team-select.selected {
            border: 2px solid var(--accent-green);
            background-color: rgba(0, 255, 139, 0.1);
        }
        
        .team-select-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--card-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--accent-green);
        }
        
        /* Live Match Interface - Compact & Mobile Optimized */
        
        /* Hide original elements */
        #live-scoring .match-header, 
        #live-scoring .teams-display, 
        #live-scoring .match-info {
            display: none;
        }

        .compact-match-header {
            background-color: var(--secondary-dark);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
        }

        .compact-match-header .team {
            text-align: center;
            flex: 1;
        }

        /* Cricket Specific: Make team logos and names smaller */
        .compact-match-header .team-logo {
            width: 40px; 
            height: 40px;
            font-size: 1rem;
            margin: 0 auto 5px; 
            border: 2px solid var(--accent-green);
            border-radius: 50%;
        }

        .compact-match-header h3 {
            font-size: 0.9rem; 
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .score-summary-mid {
            text-align: center;
            flex: 1.5;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        .score-summary-mid .live-status {
            order: -1;
        }

        .score-summary-mid .match-status {
            padding: 4px 10px;
            font-size: 0.8rem;
        }

        .score-summary-mid .vs {
            font-size: 1rem;
            font-weight: 700;
        }

        .score-summary-mid .score-line {
            font-size: 1.2rem;
            font-weight: 900;
            color: var(--accent-green);
            display: flex;
            gap: 10px;
        }
        
        /* Scorecard - PREMIUM LAYOUT FOR CRICKET */
        .scorecard-container.cricket-scorecard {
            display: flex;
            flex-direction: column;
            gap: 15px; /* Spacing between main sections */
            margin-bottom: 30px;
        }

        /* 1. Main Scoreboard block - Top section */
        #cricket-main-scoreboard {
            background-color: var(--card-dark);
            border-radius: var(--border-radius);
            padding: 25px;
            border: 1px solid var(--border-color);
        }

        .main-score-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .score-display-primary {
            font-size: 2.8rem;
            font-weight: 900;
            color: var(--accent-green);
        }
        
        .score-display-secondary {
            font-size: 1.5rem;
            color: var(--text-secondary);
            font-weight: 700;
        }
        
        /* Match Stats Bar - Premium look */
        .match-stats-bar {
            background-color: var(--secondary-dark);
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
        }
        
        .stat-item {
            padding: 5px 10px;
            white-space: nowrap;
        }

        /* Player Stats Table */
        .player-stats-table, .wicket-stats-table {
            background-color: var(--card-dark);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            overflow: hidden;
            padding: 15px;
        }

        .player-table, .fall-of-wickets-list {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        
        .player-table th, .player-table td {
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .player-table th {
            text-align: left;
            color: var(--text-muted);
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .player-table tr:last-child td {
            border-bottom: none;
        }
        
        .striker-indicator {
            color: var(--accent-green);
            font-weight: 900;
            margin-right: 5px;
        }
        
        /* Fall of Wickets List Styling */
        .fall-of-wickets-list {
            list-style: none;
        }

        .wicket-item {
            padding: 10px 0;
            border-bottom: 1px dashed var(--border-color);
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }

        .wicket-item:last-child {
            border-bottom: none;
        }

        .wicket-score {
            font-weight: bold;
            color: var(--danger);
        }
        
        /* Scoring Controls */
        .controls-grid {
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); /* Adjusted for new buttons */
            gap: 10px;
        }
        
        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
                gap: 5px;
            }
        }
        
        /* ... existing styles for buttons, mobile optimization, etc. ... */

        /* HIDDEN: Remove action history section */
        .action-history, #action-history {
            display: none !important;
        }

         /* Standard score card elements (football/custom) */
        .scorecard-container {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .scorecard-container .scorecard {
            grid-column: 1 / -1; 
        }

        /* Ball-by-ball display */
        .ball-display {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .ball {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .ball.dot { background-color: var(--border-color); }
        .ball.run { background-color: var(--success); }
        .ball.wicket { background-color: var(--danger); }
        .ball.wide { background-color: var(--warning); }
        .ball.noball, .ball.noball-run { background-color: #ff9800; }
        .ball.bye { background-color: #9c27b0; }
        .ball.legbye { background-color: #3f51b5; }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-trophy"></i>
                    <span>ScoreMaster Pro</span>
                </div>
                <button class="mobile-menu-toggle" id="mobileMenuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="user-profile">
                    <span id="tournament-name-display">Multi-Sport Tournament</span>
                    <div class="user-avatar">
                        <i class="fas fa-trophy"></i>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <nav class="main-nav hidden-on-mobile">
        <div class="nav-item active" data-section="sport-dashboard">
            <i class="fas fa-home"></i> Sport Dashboard
        </div>
        <div class="nav-item" data-section="tournament-setup">
            <i class="fas fa-plus-circle"></i> Create Tournament
        </div>
        <div class="nav-item" data-section="live-scoring">
            <i class="fas fa-broadcast-tower"></i> Live Scoring
        </div>
        <div class="nav-item" data-section="winner-announcement">
            <i class="fas fa-trophy"></i> Winner Announcement
        </div>
    </nav>
    
    <main class="container">
        <div class="step-progress" id="step-progress">
            <div class="step-indicator active" data-step="1">
                1
                <div class="step-label">Select Sport</div>
            </div>
            <div class="step-indicator" data-step="2">
                2
                <div class="step-label">Tournament Setup</div>
            </div>
            <div class="step-indicator" data-step="3">
                3
                <div class="step-label">Create Teams</div>
            </div>
            <div class="step-indicator" data-step="4">
                4
                <div class="step-label">Match Setup</div>
            </div>
            <div class="step-indicator" data-step="5">
                5
                <div class="step-label">Live Scoring</div>
            </div>
        </div>
        
        <section id="sport-dashboard" class="dashboard-section active">
            <h2>Select Sport</h2>
            <p class="subheading">Choose a sport to start your tournament</p>
            
            <div class="sport-grid">
                <div class="sport-card selected" data-sport="cricket">
                    <div class="sport-icon">
                        <i class="fas fa-baseball-ball"></i>
                    </div>
                    <h3 class="sport-name">Cricket</h3>
                </div>
                
                <div class="sport-card" data-sport="football">
                    <div class="sport-icon">
                        <i class="fas fa-futbol"></i>
                    </div>
                    <h3 class="sport-name">Football</h3>
                </div>

                <div class="sport-card" data-sport="custom">
                    <div class="sport-icon">
                        <i class="fas fa-magic"></i>
                    </div>
                    <h3 class="sport-name">Custom Sport</h3>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 40px;">
                <button class="btn" id="start-tournament-btn">
                    <i class="fas fa-arrow-right"></i> Start <span id="selected-sport-name">Cricket</span> Tournament Setup
                </button>
            </div>
        </section>
        
        <section id="tournament-setup" class="dashboard-section">
            <div class="setup-container">
                <div class="setup-step active" id="step1">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <h3 class="step-title" id="setup-title">Cricket Tournament Details</h3>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tournament Name</label>
                        <input type="text" class="form-control" id="tournament-name" placeholder="e.g., Champions League T20" value="Champions League T20">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Number of Teams</label>
                        <input type="number" class="form-control form-control-sm" id="team-count" min="2" max="16" value="4">
                        <p class="form-hint" style="color: var(--text-muted); margin-top: 5px;">Enter number of teams (2-16)</p>
                    </div>
                    
                    <div class="sport-specific-controls cricket-controls active" id="cricket-controls">
                        <div class="form-group">
                            <label class="form-label">Overs per Innings</label>
                            <div class="custom-overs-input">
                                <select class="form-control form-control-sm" id="overs-count">
                                    <option value="custom">Custom Overs</option>
                                    <option value="2">2 Overs</option>
                                    <option value="3">3 Overs</option>
                                    <option value="5">5 Overs (Quick Match)</option>
                                    <option value="6">6 Overs</option>
                                    <option value="10">10 Overs</option>
                                    <option value="20" selected>20 Overs (T20)</option>
                                    <option value="50">50 Overs (ODI)</option>
                                </select>
                                <input type="number" class="form-control form-control-sm" id="custom-overs-input" min="1" max="100" placeholder="Enter overs" style="display: none;">
                            </div>
                            <p class="form-hint" style="color: var(--text-muted); margin-top: 5px;">Select from options or choose "Custom Overs" to enter any number</p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Players per Team</label>
                            <input type="number" class="form-control form-control-sm" id="players-per-team" min="6" max="15" value="11">
                            <p class="form-hint" style="color: var(--text-muted); margin-top: 5px;">Enter players per team (6-15)</p>
                        </div>
                    </div>
                    
                    <div class="sport-specific-controls football-controls" id="football-controls">
                        <div class="form-group">
                            <label class="form-label">Match Duration (Minutes)</label>
                            <select class="form-control form-control-sm" id="football-duration">
                                <option value="30">30 mins (Friendly)</option>
                                <option value="45" selected>45 mins (Half)</option>
                                <option value="90">90 mins (Full Match)</option>
                                <option value="120">120 mins (Extra Time)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Players per Team</label>
                            <input type="number" class="form-control form-control-sm" id="football-players" min="7" max="11" value="11">
                            <p class="form-hint" style="color: var(--text-muted); margin-top: 5px;">Enter players per team (7-11)</p>
                        </div>
                    </div>
                    
                    <div class="sport-specific-controls custom-controls" id="custom-controls">
                        <div class="form-group">
                            <label class="form-label">Custom Sport Name</label>
                            <input type="text" class="form-control" id="custom-sport-name" placeholder="e.g., Ultimate Frisbee" value="Ultimate Frisbee">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Players per Team</label>
                            <input type="number" class="form-control form-control-sm" id="custom-players-per-team" min="1" max="20" value="7">
                            <p class="form-hint" style="color: var(--text-muted); margin-top: 5px;">Enter players per team (1-20)</p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Scoring Unit (e.g., Points, Goals, Sets)</label>
                            <input type="text" class="form-control form-control-sm" id="custom-scoring-unit" placeholder="Points" value="Points">
                        </div>

                         <div class="form-group">
                            <label class="form-label">Match Duration Unit (e.g., Time in mins, Sets, Rounds)</label>
                            <input type="text" class="form-control form-control-sm" id="custom-duration-unit" placeholder="Minutes" value="Minutes">
                        </div>
                    </div>
                    
                    <div class="navigation-buttons">
                        <button class="btn-outline" id="back-to-sport">
                            <i class="fas fa-arrow-left"></i> Back to Sport Selection
                        </button>
                        <button class="btn" id="next-to-teams">
                            Next: Create Teams <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="setup-step" id="step2">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <h3 class="step-title">Create Teams & Players</h3>
                    </div>
                    
                    <div id="teams-container">
                        </div>
                    
                    <div class="navigation-buttons">
                        <button class="btn-outline" id="back-to-details">
                            <i class="fas fa-arrow-left"></i> Back to Tournament Details
                        </button>
                        <button class="btn" id="next-to-match-setup">
                            Next: Match Setup <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="setup-step" id="step3">
                    <div class="step-header">
                        <div class="step-number">3</div>
                        <h3 class="step-title">Match Setup</h3>
                    </div>
                    
                    <p style="margin-bottom: 20px;">Set up the first match of your tournament</p>
                    
                    <div class="match-setup-container">
                        <div class="match-options">
                            <h4 style="margin-bottom: 15px;">Select Teams</h4>
                            <div class="teams-selection" id="teams-selection">
                                </div>
                            
                            <div style="margin-top: 30px;">
                                <h4 style="margin-bottom: 15px;" id="toss-title">Toss Winner & Decision</h4>
                                <div class="form-group">
                                    <label class="form-label" id="toss-winner-label">Toss Winner</label>
                                    <select class="form-control" id="toss-winner">
                                        </select>
                                </div>
                                
                                <div class="form-group" id="toss-decision-group">
                                    <label class="form-label">Toss Decision</label>
                                    <select class="form-control" id="toss-decision">
                                        <option value="bat">Bat First</option>
                                        <option value="bowl">Bowl First</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="match-options">
                            <h4 style="margin-bottom: 15px;">Match Preview</h4>
                            <div id="match-preview" style="padding: 20px; background-color: var(--secondary-dark); border-radius: var(--border-radius);">
                                <p style="text-align: center; margin-bottom: 15px;">Match details will appear here</p>
                                <div id="preview-teams" style="display: flex; justify-content: center; gap: 20px; margin-bottom: 20px;">
                                    <div style="text-align: center;">
                                        <div class="team-select-icon" id="preview-team1">T1</div>
                                        <div id="preview-team1-name" style="margin-top: 10px; font-weight: bold;">Team 1</div>
                                    </div>
                                    <div style="display: flex; align-items: center; font-weight: bold; color: var(--accent-green);">VS</div>
                                    <div style="text-align: center;">
                                        <div class="team-select-icon" id="preview-team2">T2</div>
                                        <div id="preview-team2-name" style="margin-top: 10px; font-weight: bold;">Team 2</div>
                                    </div>
                                </div>
                                <div id="preview-details">
                                    <p id="preview-format"><strong>Format:</strong> <span id="preview-format-value">20 overs per innings</span></p>
                                    <p id="preview-toss-line"><strong>Toss:</strong> <span id="preview-toss">Not decided yet</span></p>
                                </div>
                            </div>
                            
                            <div style="margin-top: 30px; text-align: center;">
                                <button class="btn" id="launch-tournament-btn">
                                    <i class="fas fa-rocket"></i> Launch Tournament & Start Match
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="navigation-buttons">
                        <button class="btn-outline" id="back-to-teams">
                            <i class="fas fa-arrow-left"></i> Back to Teams
                        </button>
                        <button class="btn-outline" id="modify-tournament">
                            <i class="fas fa-edit"></i> Modify Tournament
                        </button>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="live-scoring" class="dashboard-section">
            
            <div class="compact-match-header" id="compact-match-header">
                <div class="team">
                    <div class="team-logo" id="team1-logo" style="background: linear-gradient(135deg, #0047AB, #1E90FF);">T1</div>
                    <h3 id="team1-name">Team A</h3>
                </div>
                <div class="score-summary-mid">
                    <div class="live-status">
                        <span class="match-status"><span class="live-badge"></span> <span id="innings-status">1st Innings</span></span>
                    </div>
                    <div class="vs">VS</div>
                    <div class="score-line">
                        <span id="compact-team1-score">0/0 (0.0)</span> 
                        <span style="color: var(--text-muted);">:</span> 
                        <span id="compact-team2-score">To Bat</span>
                    </div>
                </div>
                <div class="team">
                    <div class="team-logo" id="team2-logo" style="background: linear-gradient(135deg, #FF0000, #FF6B6B);">T2</div>
                    <h3 id="team2-name">Team B</h3>
                </div>
            </div>
            
            <div class="scorecard-container cricket-scorecard" id="cricket-scorecard">
                
                <div id="cricket-main-scoreboard">
                    <div class="main-score-area">
                        <div style="text-align: left;">
                            <h3 id="batting-team-name" style="margin-bottom: 5px;">Team A</h3>
                            <div class="overs-display" id="current-overs">0.0 Overs</div>
                        </div>
                        <div style="text-align: right;">
                            <span class="score-display-primary" id="main-score-display">0</span>
                            <span class="score-display-secondary" id="current-score-wickets">/0</span>
                        </div>
                    </div>
                    
                    <div class="match-stats-bar" id="match-stats-bar">
                        <div class="stat-item" id="stats-target">Target: -</div>
                        <div class="stat-item" id="stats-rrr">RRR: -</div>
                        <div class="stat-item" id="stats-crr">CRR: 0.00</div>
                    </div>

                    <div style="margin-top: 20px;">
                        <h4 style="margin-bottom: 10px;">Current Over</h4>
                        <div class="ball-display" id="current-over-balls">
                            </div>
                    </div>
                </div>
                
                <div class="player-stats-table">
                    <h4 style="margin-bottom: 15px; color: var(--accent-green);">Live Match Stats</h4>
                    
                    <h5 style="margin-top: 20px; color: var(--text-secondary); margin-bottom: 5px;">Batsmen</h5>
                    <table class="player-table">
                        <thead>
                            <tr>
                                <th style="width: 50%;">Name</th>
                                <th style="width: 20%; text-align: center;">R</th>
                                <th style="width: 20%; text-align: center;">B</th>
                            </tr>
                        </thead>
                        <tbody id="batsmen-stats-body">
                            </tbody>
                    </table>

                    <h5 style="margin-top: 20px; color: var(--text-secondary); margin-bottom: 5px;">Bowler</h5>
                    <table class="player-table">
                        <thead>
                            <tr>
                                <th style="width: 50%;">Name</th>
                                <th style="width: 20%; text-align: center;">R</th>
                                <th style="width: 20%; text-align: center;">W</th>
                            </tr>
                        </thead>
                        <tbody id="bowler-stats-body">
                            </tbody>
                    </table>
                </div>

                <div class="wicket-stats-table">
                    <h4 style="margin-bottom: 15px; color: var(--accent-green);">Wickets & Score Breakdown</h4>

                    <h5 style="margin-top: 10px; color: var(--text-secondary); margin-bottom: 5px;">Fall of Wickets</h5>
                    <ul class="fall-of-wickets-list" id="fall-of-wickets-list">
                        <li class="wicket-item">No wickets yet.</li>
                    </ul>

                    <h5 style="margin-top: 20px; color: var(--text-secondary); margin-bottom: 5px;">Over Breakdown</h5>
                    <div class="overs-breakdown" id="overs-breakdown">
                        </div>
                </div>
            </div>
            
            <div class="scorecard-container football-scorecard" id="football-scorecard" style="display: none;">
                <div class="scorecard">
                    <div class="scorecard-header">
                        <h3>Match Timeline</h3>
                        <span id="football-time">00:00 / 90:00</span>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <div style="background-color: var(--secondary-dark); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="text-align: center;">
                                    <div id="football-team1-name" style="font-weight: bold; margin-bottom: 5px;">Team A</div>
                                    <div id="football-team1-goals" style="font-size: 3rem; color: var(--accent-green);">0</div>
                                </div>
                                <div style="font-size: 1.5rem; color: var(--text-muted);">:</div>
                                <div style="text-align: center;">
                                    <div id="football-team2-name" style="font-weight: bold; margin-bottom: 5px;">Team B</div>
                                    <div id="football-team2-goals" style="font-size: 3rem; color: var(--accent-green);">0</div>
                                </div>
                            </div>
                        </div>
                        
                        <h4 style="margin-bottom: 10px;">Match Events</h4>
                        <div class="action-history" id="football-events" style="display: block !important;">
                            <div class="history-item">Match started</div>
                        </div>
                    </div>
                </div>
                
                <div id="football-match-stats-hidden" style="display:none;"></div>
            </div>

            <div class="scorecard-container custom-scorecard" id="custom-scorecard" style="display: none;">
                <div class="scorecard">
                    <div class="scorecard-header">
                        <h3 id="custom-match-title">Custom Scoreboard</h3>
                        <span id="custom-status">Game Started</span>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <div style="background-color: var(--secondary-dark); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="text-align: center;">
                                    <div id="custom-team1-name" style="font-weight: bold; margin-bottom: 5px;">Team A</div>
                                    <div id="custom-team1-score" style="font-size: 3rem; color: var(--accent-green);">0</div>
                                </div>
                                <div style="font-size: 1.5rem; color: var(--text-muted);">:</div>
                                <div style="text-align: center;">
                                    <div id="custom-team2-name" style="font-weight: bold; margin-bottom: 5px;">Team B</div>
                                    <div id="custom-team2-score" style="font-size: 3rem; color: var(--accent-green);">0</div>
                                </div>
                            </div>
                            <p style="text-align: center; margin-top: 15px;">
                                <span id="custom-duration-display">Duration: 0 Minutes</span>
                            </p>
                        </div>
                        
                        <h4 style="margin-bottom: 10px;">Match Events</h4>
                        <div class="action-history" id="custom-events" style="display: block !important;">
                            <div class="history-item">Game started</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="score-controls">
                <div class="sport-specific-controls cricket-controls active" id="cricket-scoring-controls">
                    <h3 style="margin-bottom: 20px;">Cricket Scoring Controls</h3>
                    
                    <div class="controls-grid">
                        <button class="control-btn runs" data-runs="0">Dot Ball</button>
                        <button class="control-btn runs" data-runs="1">1 Run</button>
                        <button class="control-btn runs" data-runs="2">2 Runs</button>
                        <button class="control-btn runs" data-runs="3">3 Runs</button>
                        <button class="control-btn runs" data-runs="4">4 Runs</button>
                        <button class="control-btn runs" data-runs="6">6 Runs</button>
                        <button class="control-btn extras" data-extra="noball4">Nb + 4</button>
                        <button class="control-btn extras" data-extra="noball6">Nb + 6</button>
                        <button class="control-btn extras" data-extra="wide">Wide (+1)</button>
                        <button class="control-btn extras" data-extra="noball">No Ball (+1)</button>
                        <button class="control-btn extras" data-extra="bye">Bye (+1)</button>
                        <button class="control-btn extras" data-extra="legbye">Leg Bye (+1)</button>
                        <button class="control-btn wicket" data-wicket="true">Wicket</button>
                        <button class="control-btn" id="undo-btn">Undo</button>
                    </div>
                </div>
                
                <div class="sport-specific-controls football-controls" id="football-scoring-controls" style="display: none;">
                    <h3 style="margin-bottom: 20px;">Football Scoring Controls</h3>
                    
                    <div class="controls-grid">
                        <button class="control-btn" data-action="goal-team1">Goal (Team 1)</button>
                        <button class="control-btn" data-action="goal-team2">Goal (Team 2)</button>
                        <button class="control-btn" data-action="yellow-team1">Yellow Card (Team 1)</button>
                        <button class="control-btn" data-action="yellow-team2">Yellow Card (Team 2)</button>
                        <button class="control-btn" data-action="red-team1">Red Card (Team 1)</button>
                        <button class="control-btn" data-action="red-team2">Red Card (Team 2)</button>
                        <button class="control-btn" data-action="corner-team1">Corner (Team 1)</button>
                        <button class="control-btn" data-action="corner-team2">Corner (Team 2)</button>
                        <button class="control-btn" data-action="foul-team1">Foul (Team 1)</button>
                        <button class="control-btn" data-action="foul-team2">Foul (Team 2)</button>
                        <button class="control-btn" data-action="possession-team1">Possession Team 1</button>
                        <button class="control-btn" data-action="possession-team2">Possession Team 2</button>
                        <button class="control-btn" id="undo-football-btn">Undo</button>
                    </div>
                </div>

                <div class="sport-specific-controls custom-controls" id="custom-scoring-controls" style="display: none;">
                    <h3 style="margin-bottom: 20px;" id="custom-controls-title">Custom Game Controls</h3>
                    
                    <div class="controls-grid">
                        <button class="control-btn" data-action="score-1-team1" data-score="1" data-team="1">1 <span id="custom-unit-1">Point</span> (Team 1)</button>
                        <button class="control-btn" data-action="score-1-team2" data-score="1" data-team="2">1 <span id="custom-unit-2">Point</span> (Team 2)</button>
                        <button class="control-btn" data-action="score-3-team1" data-score="3" data-team="1">3 <span id="custom-unit-3">Points</span> (Team 1)</button>
                        <button class="control-btn" data-action="score-3-team2" data-score="3" data-team="2">3 <span id="custom-unit-4">Points</span> (Team 2)</button>
                        <button class="control-btn" data-action="penalty-team1" data-team="1">Penalty (Team 1)</button>
                        <button class="control-btn" data-action="penalty-team2" data-team="2">Penalty (Team 2)</button>
                        <button class="control-btn" data-action="undo-custom">Undo</button>
                    </div>
                </div>
                
                <div style="margin-top: 25px; text-align: center;" class="live-scoring-actions">
                    <button class="btn-outline btn-small" id="end-innings-btn">
                        <i class="fas fa-flag-checkered"></i> End Innings
                    </button>
                    <button class="btn-outline btn-small" id="view-stats-btn">
                        <i class="fas fa-chart-bar"></i> View Stats
                    </button>
                    
                    <button class="btn" id="declare-winner-btn">
                        <i class="fas fa-trophy"></i> Declare Winner
                    </button>
                    <button class="btn-outline" id="back-to-setup">
                        <i class="fas fa-cog"></i> Modify Setup
                    </button>
                </div>
            </div>
        </section>
        
        <section id="winner-announcement" class="dashboard-section">
            <div class="winner-container">
                <div class="trophy-icon">
                    <i class="fas fa-trophy"></i>
                </div>
                
                <h2>MATCH RESULT</h2>
                
                <div class="winner-name" id="match-winner">Team A</div>
                
                <p style="font-size: 1.3rem; margin-bottom: 20px;" id="match-result-summary">Team A won by XX runs</p>
                
                <div style="background-color: var(--secondary-dark); padding: 20px; border-radius: var(--border-radius); margin: 25px 0;">
                    <div style="display: flex; justify-content: space-around; margin-bottom: 15px;">
                        <div style="text-align: center;">
                            <div id="result-team1-name" style="font-weight: bold; margin-bottom: 5px;">Team A</div>
                            <div id="result-team1-score" style="font-size: 1.5rem; color: var(--accent-green);">0/0 (20)</div>
                        </div>
                        <div style="display: flex; align-items: center; font-weight: bold; color: var(--accent-green);">VS</div>
                        <div style="text-align: center;">
                            <div id="result-team2-name" style="font-weight: bold; margin-bottom: 5px;">Team B</div>
                            <div id="result-team2-score" style="font-size: 1.5rem; color: var(--accent-green);">0/0 (20)</div>
                        </div>
                    </div>
                    <div id="result-details">
                        <p><strong>Man of the Match:</strong> <span id="man-of-match">N/A</span></p>
                        <p><strong>Highest Run Scorer:</strong> <span id="highest-scorer">Player Name (0 runs)</span></p>
                        <p><strong>Highest Wicket Taker:</strong> <span id="highest-wicket-taker">Player Name (0 wickets)</span></p>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <button class="btn" id="new-match-btn">
                        <i class="fas fa-plus-circle"></i> Start New Match
                    </button>
                    <button class="btn-outline" id="back-to-dashboard-btn">
                        <i class="fas fa-home"></i> Back to Dashboard
                    </button>
                    <button class="btn-outline" id="view-tournament-stats-btn">
                        <i class="fas fa-chart-bar"></i> Tournament Stats
                    </button>
                </div>
            </div>
        </section>
    </main>
    
    <div class="stats-modal" id="statsModal">
        <div class="stats-content">
            <div class="stats-header">
                <h3>Match Statistics</h3>
                <button class="close-stats" id="closeStats">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="stats-content">
                </div>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <p>ScoreMaster Pro &copy; 2023 | Multi-Sport Tournament Scoring Platform</p>
            <p>Design inspired by ESPN & Cricbuzz | Complete multi-sport tournament management system</p>
        </div>
    </footer>
    
    <script>
        // Tournament Data Model
        const tournamentData = {
            sport: 'cricket',
            name: 'Champions League T20',
            teams: [],
            sportSpecific: {
                oversPerInnings: 20, // Default initialization for cricket
                playersPerTeam: 11
            },
            currentMatch: null,
            matches: []
        };
        
        // Current Match State - Generic
        let currentMatchState = {
            sport: 'cricket',
            team1: null,
            team2: null,
            innings: 1,
            isMatchStarted: false,
            actionHistory: []
        };
        
        // Cricket Match State (ENHANCED for player tracking)
        let cricketMatchState = {
            battingTeam: null,
            bowlingTeam: null,
            currentOver: 0,
            ballsInOver: 0,
            totalRuns: 0,
            wickets: 0,
            extras: 0,
            overs: [],
            currentOverBalls: [],
            isFirstInningsComplete: false,
            target: 0,
            legalBallsThisOver: 0,
            
            // NEW PLAYER TRACKING
            batsmen: [], // [{ id, name, runs, balls, isStriker: bool, fours, sixes }]
            bowler: null, // { id, name, runs, wickets, balls }
            allPlayersStats: {}, // Stores all innings stats keyed by playerId
            fallOfWickets: [] // [{ score, over, batsmanOut, fielder, bowler, dismissalType }]
        };
        
        // Custom Match State (kept as is)
        let customMatchState = {
            team1Score: 0,
            team2Score: 0,
            durationUnit: 'Minutes',
            currentDuration: 0,
            scoringUnit: 'Points',
            events: []
        };
        
        // Store previous step for navigation
        let previousSteps = [];
        let currentStep = 1;

        // Utility to find player by ID in the current batting team
        function findPlayer(playerId) {
            return cricketMatchState.batsmen.find(b => b.id === playerId);
        }

        // Utility to find player by ID across all available players (for stats aggregation)
        function findGlobalPlayer(playerId) {
            let player = cricketMatchState.battingTeam.players.find(p => p.id === playerId);
            if (player) return player;
            player = cricketMatchState.bowlingTeam.players.find(p => p.id === playerId);
            return player;
        }
        
        // Initialize the application
        function initApp() {
            // Set up event listeners
            setupEventListeners();
            
            // Initialize tournament with default values
            updateTournamentFromForm();
            
            // Generate initial teams if needed
            generateTeams();
            
            // Set up mobile menu toggle
            setupMobileMenu();
            
            // Set up navigation
            setupNavigation();
            
            // Set default team selection in match setup
            setupTeamSelectionEvents();
            
            setupCustomScoringControls(); // Setup custom controls
            
            console.log("App initialized successfully!");
        }

        function setupEventListeners() {
            console.log("Setting up event listeners...");
            
            // Sport selection
            const sportCards = document.querySelectorAll('.sport-card');
            sportCards.forEach(card => {
                card.addEventListener('click', function() {
                    sportCards.forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    tournamentData.sport = this.getAttribute('data-sport');
                    
                    // Update UI based on sport
                    updateSportUI();
                });
            });
            
            // Start tournament button
            document.getElementById('start-tournament-btn').addEventListener('click', function() {
                goToStep(2);
            });
            
            // Back to sport selection
            document.getElementById('back-to-sport').addEventListener('click', function() {
                goToStep(1);
            });
            
            // Navigation between setup steps
            document.getElementById('next-to-teams').addEventListener('click', function() {
                updateTournamentFromForm();
                generateTeams();
                goToStep(3);
            });
            
            document.getElementById('back-to-details').addEventListener('click', function() {
                goToStep(2);
            });
            
            document.getElementById('next-to-match-setup').addEventListener('click', function() {
                if (validateTeams()) {
                    setupMatchConfiguration();
                    goToStep(4);
                }
            });
            
            document.getElementById('back-to-teams').addEventListener('click', function() {
                goToStep(3);
            });
            
            // Modify tournament button
            document.getElementById('modify-tournament').addEventListener('click', function() {
                goToStep(2);
            });
            
            // Launch tournament
            document.getElementById('launch-tournament-btn').addEventListener('click', function() {
                if (setupMatch()) {
                    goToStep(5);
                    startMatch();
                }
            });
            
            // Back to setup from live scoring
            document.getElementById('back-to-setup').addEventListener('click', function() {
                if (confirm("Are you sure you want to modify the setup? Current match progress will be lost.")) {
                    goToStep(4);
                }
            });
            
            // Overs count selection change
            const oversCountSelect = document.getElementById('overs-count');
            const customOversInput = document.getElementById('custom-overs-input');
            
            if (oversCountSelect) {
                oversCountSelect.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customOversInput.style.display = 'block';
                        customOversInput.focus();
                    } else {
                        customOversInput.style.display = 'none';
                        tournamentData.sportSpecific.oversPerInnings = parseInt(this.value);
                    }
                });
            }
            
            // Custom overs input
            if (customOversInput) {
                customOversInput.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    if (value > 0 && value <= 100) {
                        tournamentData.sportSpecific.oversPerInnings = value;
                    }
                });
            }
            
            // Cricket scoring controls
            setupCricketScoringControls();
            
            // End innings button
            document.getElementById('end-innings-btn').addEventListener('click', function() {
                if (tournamentData.sport === 'cricket') {
                    if (currentMatchState.innings === 1) {
                        endFirstInnings();
                    } else {
                        endMatch();
                    }
                }
            });
            
            // Declare winner button
            document.getElementById('declare-winner-btn').addEventListener('click', endMatch);
            
            // New match button
            document.getElementById('new-match-btn').addEventListener('click', function() {
                resetMatchState();
                goToStep(4);
            });
            
            // Back to dashboard
            document.getElementById('back-to-dashboard-btn').addEventListener('click', function() {
                goToStep(1);
            });
            
            // Toss selection change
            document.getElementById('toss-winner').addEventListener('change', updateMatchPreview);
            document.getElementById('toss-decision').addEventListener('change', updateMatchPreview);
            
            // Tournament form changes
            document.getElementById('team-count').addEventListener('change', updateTournamentFromForm);
            document.getElementById('tournament-name').addEventListener('input', updateTournamentFromForm);
            
            // Custom Sport changes to update form
            document.getElementById('custom-sport-name').addEventListener('input', updateTournamentFromForm);
            document.getElementById('custom-players-per-team').addEventListener('input', updateTournamentFromForm);
            document.getElementById('custom-scoring-unit').addEventListener('input', updateTournamentFromForm);
            document.getElementById('custom-duration-unit').addEventListener('input', updateTournamentFromForm);
            
            // Stats buttons
            document.getElementById('view-stats-btn').addEventListener('click', showStatsModal);
            document.getElementById('view-tournament-stats-btn').addEventListener('click', showTournamentStats);
            document.getElementById('closeStats').addEventListener('click', function() {
                document.getElementById('statsModal').classList.remove('active');
            });
            
            // Close modal when clicking outside
            document.getElementById('statsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
            
            console.log("Event listeners setup complete!");
        }

        function setupTeamSelectionEvents() {
             // Event listener for team selection in step 3
            document.getElementById('teams-selection').addEventListener('click', function(e) {
                const teamSelect = e.target.closest('.team-select');
                if (!teamSelect) return;

                const selectedTeams = document.querySelectorAll('.team-select.selected');
                const isSelected = teamSelect.classList.contains('selected');

                if (isSelected) {
                    teamSelect.classList.remove('selected');
                } else {
                    if (selectedTeams.length < 2) {
                        teamSelect.classList.add('selected');
                    } else {
                        alert('You can only select two teams for the match.');
                    }
                }
                
                // Re-run update preview logic
                updateMatchPreview();
                
                // Update toss options whenever teams change
                const currentSelected = document.querySelectorAll('.team-select.selected');
                const tossWinnerSelect = document.getElementById('toss-winner');
                tossWinnerSelect.innerHTML = '';
                
                if (currentSelected.length > 0) {
                    currentSelected.forEach(teamElement => {
                        const teamId = parseInt(teamElement.getAttribute('data-team-id'));
                        const team = tournamentData.teams.find(t => t.id === teamId);
                        
                        const option = document.createElement('option');
                        option.value = team.id;
                        option.textContent = team.name;
                        tossWinnerSelect.appendChild(option);
                    });
                    
                    // Trigger change to update preview immediately
                    updateMatchPreview();
                }
            });
        }
        
        // Set up cricket scoring controls
        function setupCricketScoringControls() {
            console.log("Setting up cricket scoring controls...");
            
            const cricketControls = document.querySelectorAll('#cricket-scoring-controls .control-btn');
            
            cricketControls.forEach(button => {
                if (button.id !== 'undo-btn') {
                    button.addEventListener('click', function() {
                        if (!currentMatchState.isMatchStarted || tournamentData.sport !== 'cricket') {
                            showNotification("Please start the match first!", 'warning');
                            return;
                        }
                        
                        const runs = this.getAttribute('data-runs');
                        const wicket = this.getAttribute('data-wicket');
                        const extra = this.getAttribute('data-extra');
                        
                        // Store action for undo (must be done BEFORE state change)
                        const action = {
                            type: 'cricket',
                            timestamp: new Date().getTime(),
                            cricketState: JSON.parse(JSON.stringify(cricketMatchState)),
                            matchState: JSON.parse(JSON.stringify(currentMatchState))
                        };
                        
                        // Action logic
                        if (runs !== null) {
                            addCricketRun(parseInt(runs));
                        } else if (wicket !== null) {
                            promptWicketDetails(); // Initiates wicket flow
                            // Note: Wicket logic adds action to history internally after prompt/selection
                            return; // Skip default history push below
                        } else if (extra === 'noball4') {
                             addCricketExtra('noball', 4);
                        } else if (extra === 'noball6') {
                             addCricketExtra('noball', 6);
                        } else if (extra === 'wide') {
                            addCricketExtra('wide', 0);
                        } else if (extra === 'noball') {
                            addCricketExtra('noball', 0);
                        } else if (extra === 'bye') {
                            addCricketExtra('bye', 1);
                        } else if (extra === 'legbye') {
                            addCricketExtra('legbye', 1);
                        }
                        
                        // Add to history and update display
                        currentMatchState.actionHistory.push(action);
                        updateCricketDisplay();
                        
                        // Check if innings is complete
                        if (cricketMatchState.wickets >= 10 || 
                            (currentMatchState.innings === 1 && cricketMatchState.currentOver >= tournamentData.sportSpecific.oversPerInnings) ||
                            (currentMatchState.innings === 2 && cricketMatchState.totalRuns > cricketMatchState.target)) {
                            if (currentMatchState.innings === 1) {
                                endFirstInnings();
                            } else {
                                endMatch();
                            }
                        }
                    });
                }
            });
            
            // Fix the undo button event listener - add it separately
            document.getElementById('undo-btn').addEventListener('click', function() {
                if (tournamentData.sport === 'cricket') {
                    undoLastCricketAction();
                }
            });
            
            console.log("Cricket scoring controls setup complete!");
        }

        // Set up custom scoring controls (NEW)
        function setupCustomScoringControls() {
            const customControls = document.querySelectorAll('#custom-scoring-controls .control-btn');
            
            customControls.forEach(button => {
                button.addEventListener('click', function() {
                    if (!currentMatchState.isMatchStarted || tournamentData.sport !== 'custom') {
                        showNotification("Please start the match first!", 'warning');
                        return;
                    }

                    const actionType = this.getAttribute('data-action');
                    const score = parseInt(this.getAttribute('data-score'));
                    const team = parseInt(this.getAttribute('data-team'));

                    // Store action for undo
                    const action = {
                        type: 'custom',
                        timestamp: new Date().getTime(),
                        customState: JSON.parse(JSON.stringify(customMatchState)),
                        matchState: JSON.parse(JSON.stringify(currentMatchState))
                    };

                    if (actionType.includes('score')) {
                        addCustomScore(team, score);
                    } else if (actionType.includes('penalty')) {
                        addCustomEvent(`Penalty awarded to Team ${team === 1 ? '2' : '1'}`, team === 1 ? 2 : 1);
                    } else if (actionType === 'undo-custom') {
                        undoLastCustomAction();
                    }
                    
                    if (actionType !== 'undo-custom') {
                        currentMatchState.actionHistory.push(action);
                    }
                    updateCustomDisplay();
                });
            });
        }
        
        // --- NEW WICKET PROMPT FUNCTION ---
        function promptWicketDetails() {
            if (cricketMatchState.wickets >= 10) {
                showNotification("All wickets are already taken!", 'warning');
                return;
            }
            
            const striker = cricketMatchState.batsmen.find(b => b.isStriker);
            
            // Mock Prompts (In a real app, this would be a modal form)
            const dismissalType = prompt(`Wicket taken! How was ${striker.name} dismissed? (e.g., Bowled, Caught, Run Out, Stumped)`);
            if (!dismissalType) return;
            
            const isRunOut = dismissalType.toLowerCase().includes('run out');
            const fielderName = (dismissalType.toLowerCase().includes('caught') || isRunOut || dismissalType.toLowerCase().includes('stumped')) ? 
                                prompt(`Who took the catch/stumped/fielded?`) : 'N/A';

            // Wicket logic (assuming caught/bowled/stumped gives bowler credit)
            const bowlerCredit = (dismissalType.toLowerCase().includes('bowled') || dismissalType.toLowerCase().includes('caught') || dismissalType.toLowerCase().includes('stumped')) ? 
                                 (cricketMatchState.bowler ? cricketMatchState.bowler.name : 'Unknown Bowler') : 'N/A';
            
            // Store action for undo (must be done BEFORE state change)
            const action = {
                type: 'cricket',
                timestamp: new Date().getTime(),
                cricketState: JSON.parse(JSON.stringify(cricketMatchState)),
                matchState: JSON.parse(JSON.stringify(currentMatchState))
            };

            addCricketWicket(striker, dismissalType, fielderName, bowlerCredit);
            
            // Trigger full update after complex action
            currentMatchState.actionHistory.push(action);
            updateCricketDisplay();
        }
        
        // ... (Navigation, Setup functions) ...

        // CRICKET FUNCTIONS (Modified for Player Tracking)
        
        // Add runs in cricket (updates striker stats)
        function addCricketRun(runs) {
            const striker = cricketMatchState.batsmen.find(b => b.isStriker);
            const bowler = cricketMatchState.bowler;
            
            if (striker) {
                striker.runs += runs;
                striker.balls += 1;
                if (runs === 4) striker.fours += 1;
                if (runs === 6) striker.sixes += 1;
                // Update global stats
                if (cricketMatchState.allPlayersStats[striker.id]) {
                    cricketMatchState.allPlayersStats[striker.id].runs = striker.runs;
                    cricketMatchState.allPlayersStats[striker.id].balls = striker.balls;
                }
            }
            
            if (bowler) {
                bowler.balls += 1;
                bowler.runs += runs;
                // Update global stats
                if (cricketMatchState.allPlayersStats[bowler.id]) {
                    cricketMatchState.allPlayersStats[bowler.id].runsConceded = bowler.runs;
                    cricketMatchState.allPlayersStats[bowler.id].ballsBowled = bowler.balls;
                }
            }

            cricketMatchState.totalRuns += runs;
            cricketMatchState.legalBallsThisOver++;
            
            cricketMatchState.currentOverBalls.push({ 
                type: 'run', 
                value: runs,
                batsmanId: striker ? striker.id : null,
                timestamp: new Date().getTime()
            });
            
            if (runs % 2 !== 0) {
                switchStrike();
            }
            
            cricketMatchState.ballsInOver = cricketMatchState.legalBallsThisOver;
            
            if (cricketMatchState.legalBallsThisOver >= 6) {
                endOver();
            }
        }
        
        // Add wicket in cricket (updates batsman/bowler stats and FOW)
        function addCricketWicket(batsmanOut, dismissalType, fielder, bowlerCredit) {
            const striker = batsmanOut;
            
            cricketMatchState.wickets += 1;
            cricketMatchState.legalBallsThisOver++;
            
            if (cricketMatchState.bowler) {
                cricketMatchState.bowler.balls += 1;
                if (bowlerCredit !== 'N/A' && cricketMatchState.bowler.id) {
                    cricketMatchState.bowler.wickets += 1;
                    // Update global bowler stats
                    if (cricketMatchState.allPlayersStats[cricketMatchState.bowler.id]) {
                         cricketMatchState.allPlayersStats[cricketMatchState.bowler.id].wickets += 1;
                         cricketMatchState.allPlayersStats[cricketMatchState.bowler.id].ballsBowled = cricketMatchState.bowler.balls;
                    }
                }
            }
            
            // The batsman out needs one more ball added to their count
            striker.balls += 1; 

            // Record FOW
            cricketMatchState.fallOfWickets.push({
                score: cricketMatchState.totalRuns,
                over: (cricketMatchState.currentOver + (cricketMatchState.ballsInOver / 10)).toFixed(1),
                batsman: striker.name,
                dismissal: dismissalType,
                bowler: bowlerCredit,
                fielder: fielder,
                dismissalType: dismissalType // Store type
            });
            
            // Remove current striker/batsman from the crease
            cricketMatchState.batsmen = cricketMatchState.batsmen.filter(b => b.id !== striker.id);
            
            // Bring in new batsman (simple: next player in team who hasn't batted)
            const nextPlayer = cricketMatchState.battingTeam.players.find(p => 
                !cricketMatchState.allPlayersStats[p.id]
            );

            if (nextPlayer) {
                const newBatsman = initializePlayerStats(nextPlayer.id, nextPlayer.name, true);
                
                // If the player out was the non-striker (Run Out), the old striker stays on strike.
                const stayOnStrike = newBatsman.id !== striker.id;
                
                cricketMatchState.batsmen.forEach(b => b.isStriker = stayOnStrike);
                newBatsman.isStriker = !stayOnStrike;
                cricketMatchState.batsmen.push(newBatsman);
            }

            cricketMatchState.currentOverBalls.push({ 
                type: 'wicket', 
                value: 'W',
                batsmanId: striker.id,
                dismissalType: dismissalType,
                timestamp: new Date().getTime()
            });
            
            cricketMatchState.ballsInOver = cricketMatchState.legalBallsThisOver;
            
            if (cricketMatchState.legalBallsThisOver >= 6) {
                endOver();
            }
        }
        
        // Add extra in cricket (updates bowler stats for runs conceded)
        function addCricketExtra(extraType, extraRuns = 0) {
            let runs = extraRuns;
            let symbol = extraType;
            let isLegalBall = false;
            
            const bowler = cricketMatchState.bowler;
            
            switch(extraType) {
                case 'wide':
                    symbol = 'Wd';
                    runs = 1 + extraRuns;
                    if (bowler) bowler.runs += runs;
                    break;
                case 'noball':
                    symbol = extraRuns > 0 ? `Nb+${extraRuns}` : 'Nb';
                    runs = 1 + extraRuns;
                    if (bowler) bowler.runs += runs;
                    break;
                case 'bye':
                    symbol = 'B';
                    isLegalBall = true;
                    if (bowler) bowler.balls += 1;
                    break;
                case 'legbye':
                    symbol = 'Lb';
                    isLegalBall = true;
                    if (bowler) bowler.balls += 1;
                    break;
            }

            cricketMatchState.extras += runs;
            cricketMatchState.totalRuns += runs;
            
            // Update global bowler stats
            if (bowler && cricketMatchState.allPlayersStats[bowler.id]) {
                cricketMatchState.allPlayersStats[bowler.id].runsConceded = bowler.runs;
                if (isLegalBall) cricketMatchState.allPlayersStats[bowler.id].ballsBowled = bowler.balls;
            }

            // Switch strike if runs are odd (only for Byes/Legbyes/Noball runs)
            if (runs % 2 !== 0 && (extraType === 'bye' || extraType === 'legbye' || extraType === 'noball')) {
                switchStrike();
            }
            
            if (isLegalBall) {
                cricketMatchState.legalBallsThisOver++;
            }
            
            cricketMatchState.currentOverBalls.push({ 
                type: 'extra', 
                value: symbol,
                runs: runs,
                timestamp: new Date().getTime()
            });
            
            if (cricketMatchState.legalBallsThisOver >= 6) {
                endOver();
            }
        }

        // Switches strike between the two current batsmen
        function switchStrike() {
            cricketMatchState.batsmen.forEach(b => b.isStriker = !b.isStriker);
        }

        // Logic executed when an over ends (ball 6 or a wicket on the 6th ball)
        function endOver() {
            cricketMatchState.overs.push([...cricketMatchState.currentOverBalls]);
            cricketMatchState.currentOver++;
            cricketMatchState.currentOverBalls = [];
            cricketMatchState.legalBallsThisOver = 0;
            cricketMatchState.ballsInOver = 0;

            // Switch strike for the start of the next over
            switchStrike();

            // Clear bowler (requires new prompt or auto-rotation in a real app)
            cricketMatchState.bowler = null; 
        }

        // Initialize player stats structure
        function initializePlayerStats(playerId, playerName, isStriker = false) {
             const playerStat = {
                id: playerId,
                name: playerName,
                runs: 0,
                balls: 0,
                wickets: 0,
                fours: 0,
                sixes: 0,
                runsConceded: 0,
                ballsBowled: 0,
                isStriker: isStriker,
                innings: []
            };

            // Store in global stats structure
            cricketMatchState.allPlayersStats[playerId] = playerStat;
            return playerStat;
        }
        
        // Undo last cricket action
        function undoLastCricketAction() {
            if (currentMatchState.actionHistory.length === 0) {
                showNotification('No actions to undo', 'warning');
                return;
            }
            
            const lastAction = currentMatchState.actionHistory.pop();
            
            if (lastAction.type === 'cricket') {
                cricketMatchState = lastAction.cricketState;
                currentMatchState.isMatchStarted = lastAction.matchState.isMatchStarted;
                currentMatchState.innings = lastAction.matchState.innings;
                currentMatchState.actionHistory = lastAction.matchState.actionHistory; 
                
                // Re-establish team references
                if (cricketMatchState.battingTeam && cricketMatchState.battingTeam.id !== currentMatchState.team1.id) {
                    const temp = cricketMatchState.battingTeam;
                    cricketMatchState.battingTeam = currentMatchState.team1;
                    cricketMatchState.bowlingTeam = temp;
                }
                
                updateCricketDisplay();
                showNotification('Undid last action', 'success');
            } else {
                showNotification('Cannot undo this action', 'warning');
            }
        }
        
        // Update cricket display (MODIFIED for new UI elements)
        function updateCricketDisplay() {
            const overDisplay = cricketMatchState.currentOver + 
                (cricketMatchState.ballsInOver > 0 ? `.${cricketMatchState.ballsInOver}` : '');
            
            // 1. COMPACT HEADER UPDATE
            const team1IsBatting = cricketMatchState.battingTeam.id === currentMatchState.team1.id;
            const battingScore = `${cricketMatchState.totalRuns}/${cricketMatchState.wickets} (${overDisplay})`;
            const bowlingTeamTarget = cricketMatchState.target > 0 ? `Target: ${cricketMatchState.target}` : 'To Bat';
            
            document.getElementById('compact-team1-score').textContent = team1IsBatting ? battingScore : bowlingTeamTarget;
            document.getElementById('compact-team2-score').textContent = !team1IsBatting ? battingScore : bowlingTeamTarget;
            document.getElementById('innings-status').textContent = 
                `${currentMatchState.innings}${currentMatchState.innings === 1 ? 'st' : 'nd'} Innings`;
            
            // 2. MAIN SCOREBOARD
            document.getElementById('batting-team-name').textContent = cricketMatchState.battingTeam.name;
            document.getElementById('main-score-display').textContent = cricketMatchState.totalRuns;
            document.getElementById('current-score-wickets').textContent = `/${cricketMatchState.wickets}`;
            document.getElementById('current-overs').textContent = `${overDisplay} Overs`;
            
            // 3. MATCH STATS BAR
            const oversBowled = cricketMatchState.currentOver + (cricketMatchState.ballsInOver / 6);
            const runRate = oversBowled > 0 ? (cricketMatchState.totalRuns / oversBowled).toFixed(2) : '0.00';
            const totalBalls = tournamentData.sportSpecific.oversPerInnings * 6;
            const ballsBowled = cricketMatchState.currentOver * 6 + cricketMatchState.legalBallsThisOver;
            const ballsRemaining = Math.max(0, totalBalls - ballsBowled);
            
            let targetText = `Target: ${cricketMatchState.target > 0 ? cricketMatchState.target : '-'}`;
            let rrrText = 'RRR: -';
            
            if (currentMatchState.innings === 2 && cricketMatchState.target > 0) {
                const remainingRuns = cricketMatchState.target - cricketMatchState.totalRuns - 1;
                const requiredRate = ballsRemaining > 0 ? (remainingRuns / (ballsRemaining / 6)).toFixed(2) : '0.00';
                targetText = `To Win: ${Math.max(0, remainingRuns)} runs`;
                rrrText = `RRR: ${requiredRate}`;
            }

            document.getElementById('stats-target').textContent = targetText;
            document.getElementById('stats-rrr').textContent = rrrText;
            document.getElementById('stats-crr').textContent = `CRR: ${runRate}`;

            // 4. BATSMEN & BOWLER STATS
            updatePlayerStatsTables();
            
            // 5. FALL OF WICKETS
            updateFallOfWicketsList();

            // 6. OVER BREAKDOWN
            updateOversDisplay();
            
            // 7. CURRENT OVER BALLS
            updateCurrentOverBalls();
        }

        // NEW: Updates the Batsmen and Bowler Tables
        function updatePlayerStatsTables() {
            const batsmenBody = document.getElementById('batsmen-stats-body');
            const bowlerBody = document.getElementById('bowler-stats-body');
            
            batsmenBody.innerHTML = '';
            bowlerBody.innerHTML = '';

            // Batsmen Table
            cricketMatchState.batsmen.forEach(b => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        ${b.isStriker ? '<span class="striker-indicator">*</span>' : ''}${b.name}
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 2px;">
                           (${b.fours} 4s, ${b.sixes} 6s)
                        </div>
                    </td>
                    <td style="text-align: center; font-weight: bold; color: ${b.runs >= 50 ? 'var(--accent-green)' : 'var(--text-primary)'};">${b.runs}</td>
                    <td style="text-align: center; color: var(--text-secondary);">${b.balls}</td>
                `;
                batsmenBody.appendChild(row);
            });
            
            // Bowler Table
            if (cricketMatchState.bowler) {
                const b = cricketMatchState.bowler;
                const overs = Math.floor(b.balls / 6) + '.' + (b.balls % 6);
                const runRate = b.balls > 0 ? (b.runs / (b.balls / 6)).toFixed(2) : '0.00';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <span style="font-weight: bold;">${b.name}</span>
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 2px;">
                           ${overs} Overs (ER: ${runRate})
                        </div>
                    </td>
                    <td style="text-align: center; color: var(--text-secondary);">${b.runs}</td>
                    <td style="text-align: center; font-weight: bold; color: var(--danger);">${b.wickets}</td>
                `;
                bowlerBody.appendChild(row);
            } else {
                 bowlerBody.innerHTML = `<tr><td colspan="3" style="text-align: center; color: var(--text-muted);">Select New Bowler</td></tr>`;
                 // In a real app, this should prompt the user to select the next bowler
            }
        }

        // NEW: Updates the Fall of Wickets List
        function updateFallOfWicketsList() {
            const fowList = document.getElementById('fall-of-wickets-list');
            fowList.innerHTML = '';

            if (cricketMatchState.fallOfWickets.length === 0) {
                 fowList.innerHTML = '<li class="wicket-item">No wickets yet.</li>';
                 return;
            }

            cricketMatchState.fallOfWickets.forEach((fow, index) => {
                const item = document.createElement('li');
                item.className = 'wicket-item';
                
                let details = `${fow.dismissalType} - ${fow.batsman} (`;
                if (fow.bowler && fow.bowler !== 'N/A') {
                    details += `b: ${fow.bowler}`;
                }
                if (fow.fielder && fow.fielder !== 'N/A') {
                    details += (fow.bowler !== 'N/A' ? ', ' : '') + `f: ${fow.fielder}`;
                }
                details += `)`;

                item.innerHTML = `
                    <span>${details}</span>
                    <span class="wicket-score">${fow.score}-${index + 1} (${fow.over} Ov)</span>
                `;
                fowList.appendChild(item);
            });
        }
        
        // Initialize cricket display
        function initializeCricketDisplay() {
            
            // NEW: Initialize current batsman and bowler
            if (cricketMatchState.battingTeam.players.length >= 2) {
                // Initialize all players' global stats first
                cricketMatchState.battingTeam.players.forEach(p => initializePlayerStats(p.id, p.name, false));
                
                // Set the two starting batsmen
                cricketMatchState.batsmen = [
                    cricketMatchState.allPlayersStats[cricketMatchState.battingTeam.players[0].id],
                    cricketMatchState.allPlayersStats[cricketMatchState.battingTeam.players[1].id]
                ];
                cricketMatchState.batsmen[0].isStriker = true;
                cricketMatchState.batsmen[1].isStriker = false;
            }
            
            // Simple initialization of bowler (Player 11)
            if (cricketMatchState.bowlingTeam.players.length >= 11) {
                cricketMatchState.bowler = initializePlayerStats(cricketMatchState.bowlingTeam.players[10].id, cricketMatchState.bowlingTeam.players[10].name);
            }
            
            // Initialize overs breakdown
            const oversBreakdown = document.getElementById('overs-breakdown');
            oversBreakdown.innerHTML = '';
            
            for (let i = 0; i < tournamentData.sportSpecific.oversPerInnings; i++) {
                const overCell = document.createElement('div');
                overCell.className = 'over-cell';
                overCell.id = `over-${i+1}`;
                overCell.textContent = '0';
                oversBreakdown.appendChild(overCell);
            }
            
            updateCricketDisplay();
        }
        
        // End first innings in cricket
        function endFirstInnings() {
            cricketMatchState.isFirstInningsComplete = true;
            cricketMatchState.target = cricketMatchState.totalRuns + 1;
            
            // Store final score of first innings team
            const firstInningsTeamId = cricketMatchState.battingTeam.id;
            const finalScore = {
                runs: cricketMatchState.totalRuns,
                wickets: cricketMatchState.wickets,
                overs: cricketMatchState.currentOver + (cricketMatchState.ballsInOver / 6)
            };
            
            // Swap batting and bowling teams
            const temp = cricketMatchState.battingTeam;
            cricketMatchState.battingTeam = cricketMatchState.bowlingTeam;
            cricketMatchState.bowlingTeam = temp;
            
            // Reset for second innings
            currentMatchState.innings = 2;
            
            // Persist the player stats, but reset match state variables
            const persistedStats = cricketMatchState.allPlayersStats;

            cricketMatchState = {
                battingTeam: cricketMatchState.battingTeam,
                bowlingTeam: cricketMatchState.bowlingTeam,
                currentOver: 0,
                ballsInOver: 0,
                totalRuns: 0,
                wickets: 0,
                extras: 0,
                overs: [],
                currentOverBalls: [],
                isFirstInningsComplete: true,
                target: cricketMatchState.target,
                legalBallsThisOver: 0,
                
                batsmen: [], 
                bowler: null,
                allPlayersStats: persistedStats, // Keep the old stats
                fallOfWickets: [] 
            };
            
            // Setup new batsmen/bowler for the second innings
             if (cricketMatchState.battingTeam.players.length >= 2) {
                cricketMatchState.batsmen = [
                    cricketMatchState.allPlayersStats[cricketMatchState.battingTeam.players[0].id],
                    cricketMatchState.allPlayersStats[cricketMatchState.battingTeam.players[1].id]
                ];
                cricketMatchState.batsmen[0].isStriker = true;
                cricketMatchState.batsmen[1].isStriker = false;
            }
            
            if (cricketMatchState.bowlingTeam.players.length >= 11) {
                cricketMatchState.bowler = initializePlayerStats(cricketMatchState.bowlingTeam.players[10].id, cricketMatchState.bowlingTeam.players[10].name);
            }

            currentMatchState.actionHistory = []; 
            
            // Update UI
            document.getElementById('innings-status').textContent = `2nd Innings`;
            document.getElementById('batting-team-name').textContent = cricketMatchState.battingTeam.name;
            
            // Reset wickets and overs display
            initializeCricketDisplay();
            
            // Update the score lines for end match purposes
            if (currentMatchState.team1.id === firstInningsTeamId) {
                 currentMatchState.team1Score = finalScore;
            } else {
                 currentMatchState.team2Score = finalScore;
            }

            
            showNotification(`First innings complete! ${cricketMatchState.bowlingTeam.name} needs ${cricketMatchState.target} runs to win.`, 'success');
        }
        
        // End match and declare winner (MODIFIED to calculate top players)
        function endMatch() {
            let winner = null, resultSummary;
            
            if (tournamentData.sport === 'cricket') {
                // Final score for the team that batted last (currently in cricketMatchState)
                const lastTeamId = cricketMatchState.battingTeam.id;
                const finalScoreLast = {
                    runs: cricketMatchState.totalRuns,
                    wickets: cricketMatchState.wickets,
                    overs: cricketMatchState.currentOver + (cricketMatchState.ballsInOver / 6)
                };
                
                if (currentMatchState.team1.id === lastTeamId) {
                    currentMatchState.team1Score = finalScoreLast;
                } else {
                    currentMatchState.team2Score = finalScoreLast;
                }
                
                // Calculate total match statistics for High Score/Wicket Taker
                let allBatters = {};
                let allBowlers = {};
                
                // Aggregate all player stats
                Object.values(cricketMatchState.allPlayersStats).forEach(p => {
                    if (p.runs > 0) allBatters[p.name] = (allBatters[p.name] || 0) + p.runs;
                    if (p.wickets > 0) allBowlers[p.name] = (allBowlers[p.name] || 0) + p.wickets;
                });
                
                // Find Highest Run Scorer
                const topScorer = Object.keys(allBatters).reduce((a, b) => allBatters[a] > allBatters[b] ? a : b, null);
                const topScorerRuns = topScorer ? allBatters[topScorer] : 0;

                // Find Highest Wicket Taker
                const topWicketTaker = Object.keys(allBowlers).reduce((a, b) => allBowlers[a] > allBowlers[b] ? a : b, null);
                const topWicketTakerWickets = topWicketTaker ? allBowlers[topWicketTaker] : 0;
                
                // Update final result summary based on scores
                const s1 = currentMatchState.team1Score;
                const s2 = currentMatchState.team2Score;
                
                if (s1.runs > s2.runs) {
                    winner = currentMatchState.team1;
                    if (currentMatchState.innings === 1) { resultSummary = `${winner.name} won by declaration`; } 
                    else if (currentMatchState.team1.id === lastTeamId) { resultSummary = `${winner.name} won by ${10 - s1.wickets} wickets`; } 
                    else { resultSummary = `${winner.name} won by ${s1.runs - s2.runs} runs`; }
                } else if (s2.runs > s1.runs) {
                    winner = currentMatchState.team2;
                    if (currentMatchState.innings === 1) { resultSummary = `${winner.name} won by declaration`; } 
                    else if (currentMatchState.team2.id === lastTeamId) { resultSummary = `${winner.name} won by ${10 - s2.wickets} wickets`; } 
                    else { resultSummary = `${winner.name} won by ${s2.runs - s1.runs} runs`; }
                } else {
                    resultSummary = "Match Tied";
                    winner = null;
                }

                // Update final result display
                document.getElementById('highest-scorer').textContent = `${topScorer || 'N/A'} (${topScorerRuns} runs)`;
                document.getElementById('highest-wicket-taker').textContent = `${topWicketTaker || 'N/A'} (${topWicketTakerWickets} wickets)`;
                
            } else if (tournamentData.sport === 'custom') {
                if (customMatchState.team1Score > customMatchState.team2Score) {
                    winner = currentMatchState.team1;
                    resultSummary = `${winner.name} won by ${customMatchState.team1Score - customMatchState.team2Score} ${tournamentData.sportSpecific.scoringUnit}`;
                } else if (customMatchState.team2Score > customMatchState.team1Score) {
                     winner = currentMatchState.team2;
                    resultSummary = `${winner.name} won by ${customMatchState.team2Score - customMatchState.team1Score} ${tournamentData.sportSpecific.scoringUnit}`;
                } else {
                    resultSummary = "Match Tied";
                    winner = null;
                }
                
                currentMatchState.team1Score = {runs: customMatchState.team1Score, wickets: 0, overs: 0};
                currentMatchState.team2Score = {runs: customMatchState.team2Score, wickets: 0, overs: 0};
                document.getElementById('highest-scorer').textContent = `N/A`;
                document.getElementById('highest-wicket-taker').textContent = `N/A`;
            } else {
                // Fallback for Football
                winner = currentMatchState.team1;
                resultSummary = `${winner.name} won the match`;
                document.getElementById('highest-scorer').textContent = `N/A`;
                document.getElementById('highest-wicket-taker').textContent = `N/A`;
            }

            // Update winner announcement
            if (winner) {
                document.getElementById('match-winner').textContent = winner.name;
            } else {
                document.getElementById('match-winner').textContent = 'DRAW';
            }
            
            document.getElementById('match-result-summary').textContent = resultSummary;
            
            // Update result details based on sport
            const s1 = currentMatchState.team1Score || {runs: 0, wickets: 0, overs: 0};
            const s2 = currentMatchState.team2Score || {runs: 0, wickets: 0, overs: 0};
            
            document.getElementById('result-team1-name').textContent = currentMatchState.team1.name;
            document.getElementById('result-team2-name').textContent = currentMatchState.team2.name;
            
            if (tournamentData.sport === 'cricket') {
                document.getElementById('result-team1-score').textContent = `${s1.runs}/${s1.wickets} (${s1.overs.toFixed(1)} Ov)`;
                document.getElementById('result-team2-score').textContent = `${s2.runs}/${s2.wickets} (${s2.overs.toFixed(1)} Ov)`;
            } else if (tournamentData.sport === 'custom') {
                 const unit = tournamentData.sportSpecific.scoringUnit;
                 document.getElementById('result-team1-score').textContent = `${s1.runs} ${unit}`;
                 document.getElementById('result-team2-score').textContent = `${s2.runs} ${unit}`;
            } else {
                 document.getElementById('result-team1-score').textContent = `Score: ${s1.runs}`;
                 document.getElementById('result-team2-score').textContent = `Score: ${s2.runs}`;
            }

            document.getElementById('man-of-match').textContent = 'N/A';
            
            // Go to winner announcement
            showSection('winner-announcement');
            document.querySelector('.nav-item[data-section="winner-announcement"]').classList.add('active');
        }
        
        // ... (rest of the functions: updateOversDisplay, updateCurrentOverBalls, custom functions, etc.) ...
        
        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, initializing app...");
            initApp();
        });
    </script>
</body>
</html>
